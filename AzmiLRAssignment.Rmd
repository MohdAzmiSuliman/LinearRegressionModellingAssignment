---
title: "Linear Regression Modelling Assignment"
author: "Mohd Azmi"
date: "22/10/2019"
output:
  rmdformats::material:
    highlight: haddock
resource_files:
- AzmiLRAssignment.html
---

# Pre-amble

## Loading Library

```{r Loading Library, echo=FALSE}
library(foreign)
library(tidyverse)
library(corrplot)
library(knitr)
library(broom)
library(tidyr)
library(psych)
library(rmdformats)
```


## Loading Dataset

```{r}
Data01 <- read.spss("weights.sav", use.value.label=T, to.data.frame=T)
```

# Modelling

## Descriptive

```{r Descriptive Exploratory}
summary(Data01)
Data01 %>% describe()
```

## Data Exploration

Histogram

```{r Explore Numerical}
ggplot(Data01, aes(weight)) + geom_histogram()
ggplot(Data01, aes(length)) + geom_histogram()
ggplot(Data01, aes(headc)) + geom_histogram()

```

correlation Matrix and Correlogram

```{r Correlation and Correllogram}
Data02 <- Data01 %>% 
  select_if(is.numeric)
  
CorData02 <- cor(Data02, use = "complete.obs", method = "pearson")
head(round(CorData02,2))

corrplot(CorData02, method = "circle")
```

## Univariate

### Model 1

outcome: Head Circumference
covariate: weight

```{r LM Model01}

ModelWeight <- lm(headc ~ weight, data = Data01)
summary(ModelWeight)
tidy(ModelWeight, conf.int = T)
```

### Model 2

outcome: Head Circumference
covariate: length

```{r LM Model02}

ModelLength <- lm(headc ~ length, data = Data01)
summary(ModelLength)
tidy(ModelLength, conf.int = T)
```

### Model 3

outcome: Head Circumference
covariate: gender

```{r LM Model03}

ModelGender <- lm(headc ~ gender, data = Data01)
summary(ModelGender)
tidy(ModelGender, conf.int = T)
```

### Model 4

outcome: Head Circumference
covariate: Mother's Education

```{r LM Model04}

ModelEducation <- lm(headc ~ educatio, data = Data01)
summary(ModelEducation)
tidy(ModelEducation, conf.int = T)
```

### Model 5

outcome: Head Circumference
covariate: parity

```{r LM Model05}

ModelParity <- lm(headc ~ parity, data = Data01)
summary(ModelParity)
tidy(ModelParity, conf.int = T)
```

### Univariable Summary

all simple linear regressions were significant, except for variable mother education.

# Multivariable

To explore which covariate is the predictor for newborn's head circumference, several multiple linear regression models are created.

## Model Exploration

### Model 11

Outcome: Head Circumference
Covariate: Weight and Length

```{r LM ModelWeightLength}

ModelWeightLength <- lm(headc ~ weight + length, data = Data01)
summary(ModelWeightLength)
tidy(ModelWeightLength, conf.int = T)
```

### Model 12

Outcome: Head Circumference
Covariate: Weight, Length + gender + mother education + parity

```{r LM ModelWtLtGenEduPar}

ModelWtLtGenEduPar <- lm(headc ~ weight + length + gender + educatio + parity, data = Data01)
summary(ModelWtLtGenEduPar)
tidy(ModelWtLtGenEduPar, conf.int = T)
```

### Model 13

Outcome: Head Circumference
Covariate: Weight, Length + gender + parity

```{r LM ModelWtLtGenPar}

ModelWtLtGenPar <- lm(headc ~ weight + length + gender + parity, data = Data01)
summary(ModelWtLtGenEduPar)
tidy(ModelWtLtGenPar, conf.int = T)
```

## Model Comparison

```{r Model Comparison}
anova(ModelWeightLength, ModelWtLtGenEduPar)
anova(ModelWeightLength, ModelWtLtGenPar)
anova(ModelWtLtGenEduPar, ModelWtLtGenPar)
```

For model comparison, between ModelWtLtGenEduPar and ModelWtLtGenPar, there is no significant different. Thus, ModelWtLtGenEduPar is not selected. 

Thus, to choose either ModelWeightLength or ModelWtLtGenPar, adjusted R<sup>2</sup> will be use as guidance.

for ModelWeightLength, the adjusted R<sup>2</sup> is 0.4339, while ModelWtLtGenPar, adjusted R<sup>2</sup>is 0.4452. thus ModelWtLtGenPar is choosed.

## Handling Confounding

There is high correlation between variable weight and length.

```{r Confounder Exploration}
ggplot(Data01, aes(weight, length)) + geom_point() + stat_smooth(method = 'lm', col = 'green')
```


### Model 21

outcome: head circumference
covariate: Gender + Parity + Weight

```{r ModelGenParWt}
ModelGenParWt <- lm(headc ~ weight + gender + parity, data = Data01)
summary(ModelGenParWt)
ModelGenParWt01 <- tidy(ModelGenParWt)
ModelGenParWt01
```

### Model 22

outcome: head circumference
covariate: Gender + Parity + Length

```{r ModelGenParLt}
ModelGenParLt <- lm(headc ~ length + gender + parity, data = Data01)
summary(ModelGenParLt)
ModelGenParLt01 <- tidy(ModelGenParLt)
ModelGenParLt
```

### Model 23

outcome: head circumference
covariate: Gender + Parity + Weight + Length

```{r ModelGenParWtLt}
ModelGenParWtLt <- lm(headc ~ weight + length + gender + parity, data = Data01)
summary(ModelGenParWtLt)
ModelGenParWtLt01 <-tidy(ModelGenParWtLt)
ModelGenParWtLt01
```

### Model Comparison

for Weight

```{r}
((ModelGenParWtLt01 [2,2] - ModelGenParWt01 [2,2])/ ModelGenParWt01 [2,2])*100
```

for Length

```{r}
((ModelGenParWtLt01 [2,2] - ModelGenParLt01 [2,2])/ ModelGenParLt01 [2,2])*100
```


Since Length have bigger difference, weight will be removed from the model. In addition to that, adjusted R<sup>2</sup> for model with length is higher than model with weight variable.

## Interaction

Model to check for interaction is

Outcome: Head Circumference
Covariate: length, gender and parity

### Interaction term - Length and Gender

Outcome: Head Circumference
Covariate: length, gender, parity, length*gender

```{r ModelGenParLt_LtGen}
ModelGenParLt_LtGen <- lm(headc ~ length + gender + parity + length:gender, data = Data01)
summary(ModelGenParLt_LtGen)
tidy(ModelGenParLt)
tidy(ModelGenParLt_LtGen)
anova(ModelGenParLt_LtGen, ModelGenParLt)
```

interaction term between length and gender is not significant.

### Interaction term - Length and Parity

Outcome: Head Circumference
Covariate: length, gender, parity, length*parity

```{r ModelGenParLt_LtPar}
ModelGenParLt_LtPar <- lm(headc ~ length + gender + parity + length:parity, data = Data01)
summary(ModelGenParLt_LtPar)
tidy(ModelGenParLt)
tidy(ModelGenParLt_LtPar)
anova(ModelGenParLt_LtPar, ModelGenParLt)
```

there is interaction between variable length and parity

### Interaction term - Gender and Parity

Outcome: Head Circumference
Covariate: length, gender, parity, gender*parity

```{r ModelGenParLt_GenPar}
ModelGenParLt_GenPar <- lm(headc ~ length + gender + parity + gender:parity, data = Data01)
summary(ModelGenParLt_GenPar)
tidy(ModelGenParLt)
tidy(ModelGenParLt_GenPar)
anova(ModelGenParLt_GenPar, ModelGenParLt)
```

interaction term between gender and parity is not significant.

## Model Assesment

Preliminary Final Model
Outcome: Head Circumference
Covariate: length, gender, parity, length*parity

```{r Prelim Final Model}

ModelGenParLt_LtPar <- lm(headc ~ length + gender + parity + length:parity, data = Data01)

```

### Predictor Value

```{r}
Pred.PrelimFinalModel <- augment(ModelGenParLt_LtPar)
kable(head(Pred.PrelimFinalModel))
```

### Normality Test for Residual

Histogram for Residual to look for distribution shape.

```{r Histogram Residual}
ggplot(data = Pred.PrelimFinalModel, aes(x=.resid)) + geom_histogram()
```

Scatter plot between predicted and residual values.

```{r Scatter Plot Predicted vs Residual}
ggplot(data = Pred.PrelimFinalModel, aes(x=.fitted, y=.resid)) + geom_point() + geom_hline (yintercept = 0)
```

Thus, these two assumption for linear regression is fulfilled
1. for each set of $X$<sub>i</sub> values, there is a subpopulation of Y values which are normally distributed.
2. the variance of the sub-population of Y are all equal

# Prediction with New Data

## Create New Dataset

create new data 

```{r New Data}
new_data <- expand.grid(length = c(45, 50, 55, 60, 65),
                        gender = c('Male', 'Female'),
                        parity = c('Singleton', 'One sibling','2 siblings', '3 or more siblings'))
head(new_data)
```

## Calculate Predicted Values with New Dataset

```{r Preidcted with New Data}
DataSetPred.NewDt <- augment(ModelGenParLt_LtPar, newdata = new_data)
DataSetPred.NewDt
```

# Explore Influential

Measure influential in the model
1. cooks distanc: value above 1 or above 4/n
2. standardized residual: values above 2 or lower than -2

```{r}
(2*4 +2)/550
```


3. leverage above (2k +2)/n = 0.0182


```{r Dataset Influential}
influen.obs <- Pred.PrelimFinalModel %>% filter(.std.resid > 2 | .std.resid < -2 | .hat > 0.0182)
influen.obs
```


## Dataset with Standardized Residual between 2 and -2

```{r Dataset without Influential}
NonInfluenObs <- Pred.PrelimFinalModel %>% filter(.std.resid < 2 | .std.resid > -2 | .hat < 0.0182)
NonInfluenObs
```

the model is re-run using dataset without influential

```{r Model with Dataset without Influential}
FinalModelNoInfluential <- lm(ModelGenParLt_LtPar, data = NonInfluenObs)
```


## Diagnostic Plot for Model without influential

```{r}
plot(FinalModelNoInfluential)
```

# Final Model

Model
$y = \beta_0 + \beta_1X_1 + \beta_2X_2 + \beta_3X_3 + \beta_4X_1X_2$

$X_1$ - length
$X_2$ - gehder
$X_3$ - parity

```{r Final Model}
tidy(ModelGenParLt_LtPar, conf.int = T)
```


head circumference = 18.45 + 0.36 (length) - 0.52 (female = 1) + 4.29 (One sibling = 1) + 1.71 (2 siblings = 1) + 8.48 (3 or more siblings = 1) - 0.07 (length:one sibling) - 0.02 (length:2sibling) - 0.15 (length:3 or more siblings)
